#!/bin/bash
# XMonad startup xinitrc
# This will use the xmonad-start script that includes system tray components

# Configure X settings for XScreensaver
xset s off
xset -dpms

# Also start the USB keyboard monitor in background
if [ -x /home/valdimar/dotfiles-claude/scripts/monitor-usb-keyboard.sh ]; then
    /home/valdimar/dotfiles-claude/scripts/monitor-usb-keyboard.sh &
fi

# Start XScreensaver daemon
xscreensaver -no-splash &

# Auto-configure external monitors
# Get the primary display (usually eDP-1, eDP1, or LVDS-1 for laptops)
PRIMARY=$(xrandr | grep " connected primary" | cut -d' ' -f1)
# If no primary is set, try to find the laptop display
if [ -z "$PRIMARY" ]; then
    PRIMARY=$(xrandr | grep -E "^(eDP|LVDS|LVDS-?[0-9]|eDP-?[0-9]) connected" | head -n1 | cut -d' ' -f1)
fi

# Use the xmonad-start script if it exists, otherwise fallback to basic xmonad
if [ -x "$HOME/.xmonad/xmonad-start" ]; then
    exec "$HOME/.xmonad/xmonad-start"
else
    # Fallback: basic XMonad startup
    # Set Caps Lock as Ctrl
    setxkbmap -option ctrl:nocaps

    # Start system tray components manually
    stalonetray &
    nm-applet --indicator &
    sleep 2
    pasystray &
    blueman-applet &

    # Start compositor
    if command -v picom > /dev/null 2>&1; then
        picom -b --config ~/.config/picom/picom.conf 2>/dev/null || picom -b &
    fi

    exec xmonad
fi